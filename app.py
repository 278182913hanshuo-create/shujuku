import streamlit as st
import pandas as pd
import requests
import json
from datetime import datetime
import time

# --- é¡µé¢é…ç½® ---
st.set_page_config(
    page_title="ä¾›åº”å•†è®¾å¤‡ä»·æ ¼æ•°æ®åº“ (é£ä¹¦ç‰ˆ)",
    page_icon="ğŸ¼",
    layout="wide"
)

# --- ç™»å½•éªŒè¯åŠŸèƒ½ ---
def check_login():
    """ç®€å•çš„ç™»å½•éªŒè¯"""
    if "authenticated" not in st.session_state:
        st.session_state.authenticated = False

    if st.session_state.authenticated:
        return True

    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.title("ğŸ” ç³»ç»Ÿç™»å½•")
        st.info("")
        
        with st.form("login_form"):
            username = st.text_input("è´¦å·")
            password = st.text_input("å¯†ç ", type="password")
            submitted = st.form_submit_button("ç™»å½•")

            if submitted:
                # ä¼˜å…ˆä» Secrets è¯»å– [credentials] é…ç½®
                valid_users = st.secrets.get("credentials", {"admin": "123456"})
                
                if username in valid_users and valid_users[username] == password:
                    st.session_state.authenticated = True
                    st.success("ç™»å½•æˆåŠŸï¼")
                    time.sleep(0.5)
                    st.rerun()
                else:
                    st.error("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚")
    
    return False

# --- é£ä¹¦ API å·¥å…·ç±» ---
class FeishuConnector:
    def __init__(self):
        if "feishu" not in st.secrets:
            st.error("æœªæ‰¾åˆ°é£ä¹¦é…ç½®ï¼è¯·åœ¨ Secrets ä¸­é…ç½® app_id, app_secret, app_token, table_idã€‚")
            st.stop()
        
        self.app_id = st.secrets["feishu"]["app_id"]
        self.app_secret = st.secrets["feishu"]["app_secret"]
        self.app_token = st.secrets["feishu"]["app_token"]
        self.table_id = st.secrets["feishu"]["table_id"]
        self.token_url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
        self.base_url = f"https://open.feishu.cn/open-apis/bitable/v1/apps/{self.app_token}/tables/{self.table_id}/records"

    def get_token(self):
        headers = {"Content-Type": "application/json; charset=utf-8"}
        data = {
            "app_id": self.app_id,
            "app_secret": self.app_secret
        }
        response = requests.post(self.token_url, headers=headers, json=data)
        if response.status_code == 200:
            return response.json().get("tenant_access_token")
        else:
            st.error(f"è·å– Token å¤±è´¥: {response.text}")
            return None

    def get_records(self):
        token = self.get_token()
        if not token: return []
        
        headers = {"Authorization": f"Bearer {token}"}
        params = {"page_size": 100} 
        
        try:
            response = requests.get(self.base_url, headers=headers, params=params)
            res_json = response.json()
            
            if res_json.get("code") == 0:
                items = res_json["data"]["items"]
                clean_data = []
                for item in items:
                    row = item["fields"]
                    row["_record_id"] = item["record_id"]
                    clean_data.append(row)
                return clean_data
            else:
                st.error(f"è¯»å–æ•°æ®å¤±è´¥: {res_json.get('msg')}")
                return []
        except Exception as e:
            st.error(f"ç½‘ç»œè¯·æ±‚é”™è¯¯: {e}")
            return []

    def add_record(self, data_dict):
        token = self.get_token()
        if not token: return False
        
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json; charset=utf-8"
        }
        payload = {"fields": data_dict}
        
        response = requests.post(self.base_url, headers=headers, json=payload)
        res_json = response.json()
        
        if res_json.get("code") == 0:
            return True
        else:
            st.error(f"å†™å…¥å¤±è´¥: {res_json.get('msg')}")
            return False

    def delete_record(self, record_id):
        token = self.get_token()
        if not token: return False
        
        headers = {"Authorization": f"Bearer {token}"}
        delete_url = f"{self.base_url}/{record_id}"
        
        response = requests.delete(delete_url, headers=headers)
        res_json = response.json()
        
        if res_json.get("code") == 0:
            return True
        else:
            st.error(f"åˆ é™¤å¤±è´¥: {res_json.get('msg')}")
            return False

# ==========================================
#  ä¸»ç¨‹åºé€»è¾‘
# ==========================================

if check_login():
    connector = FeishuConnector()

    st.sidebar.title("ğŸ¼ é£ä¹¦äº‘æ•°æ®åº“")
    
    if st.sidebar.button("ğŸšª é€€å‡ºç™»å½•"):
        st.session_state.authenticated = False
        st.rerun()
        
    menu = st.sidebar.radio("åŠŸèƒ½èœå•", ["ğŸ“Š æ•°æ®æŸ¥è¯¢", "â• å½•å…¥æŠ¥ä»·", "ğŸ“ˆ ä»·æ ¼åˆ†æ"])
    st.sidebar.markdown("---")
    st.sidebar.caption("æ•°æ®æºï¼šé£ä¹¦å¤šç»´è¡¨æ ¼")

    # å®šä¹‰éƒ¨é—¨åˆ—è¡¨
    DEPARTMENTS = ["ç”µåŠ›ç‰©è”ç½‘ä¸­å¿ƒ", "æ•°å­—åŒ–ä¸­å¿ƒ", "ä¿¡é€šå’Œé•‡æ±Ÿåˆ†å…¬å¸"]

    # --- åŠŸèƒ½ 1: æ•°æ®æŸ¥è¯¢ ---
    if menu == "ğŸ“Š æ•°æ®æŸ¥è¯¢":
        st.title("ğŸ“Š ä¾›åº”å•†é‡‡è´­æˆæœ¬æ•°æ®åº“")
        
        with st.spinner("æ­£åœ¨è¿æ¥é£ä¹¦æœåŠ¡å™¨..."):
            data = connector.get_records()
        
        if data:
            df = pd.DataFrame(data)
            
            # è¿™é‡Œçš„åˆ—åå¿…é¡»ä¸é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­çš„åˆ—åå®Œå…¨ä¸€è‡´
            cols = ["åºå·", "æ‰€å±éƒ¨é—¨", "é¡¹ç›®åœ°ç‚¹", "è®¾å¤‡ç±»å‹", "è®¾å¤‡æ•°é‡", "å•ä»·", "ä¸­æ ‡åˆåŒé¢", "ä¾›è´§æ—¥æœŸ", "é‡‡è´­å»ºè®®", "ä¾›åº”å•†", "è¯¢ä»·å•ä»·", "è¯¢ä»·æ€»ä»·", "è”ç³»äºº", "å½•å…¥æ—¶é—´", "å¤‡æ³¨", "_record_id"]
            
            # ç¡®ä¿åˆ—å­˜åœ¨
            available_cols = [c for c in cols if c in df.columns]
            df = df[available_cols]

            # ä½¿ç”¨ Tabs åˆ’åˆ†ä¸‰ä¸ªéƒ¨é—¨
            tabs = st.tabs(DEPARTMENTS)
            
            for i, dept_name in enumerate(DEPARTMENTS):
                with tabs[i]:
                    st.header(f"ğŸ“ {dept_name} æ•°æ®")
                    
                    # ç­›é€‰å¯¹åº”éƒ¨é—¨çš„æ•°æ®
                    if "æ‰€å±éƒ¨é—¨" in df.columns:
                        dept_df = df[df["æ‰€å±éƒ¨é—¨"] == dept_name]
                    else:
                        dept_df = pd.DataFrame(columns=available_cols)
                        if i == 0: st.warning("âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°é£ä¹¦è¡¨æ ¼ç¼ºå°‘ã€æ‰€å±éƒ¨é—¨ã€‘åˆ—ï¼Œæ— æ³•è¿›è¡Œåˆ†ç±»ç­›é€‰ã€‚è¯·å»é£ä¹¦æ·»åŠ è¯¥åˆ—ã€‚")

                    # éƒ¨é—¨å†…çš„æœç´¢
                    c1, c2 = st.columns(2)
                    with c1:
                        # åŠ ä¸Škeyé¿å…ç»„ä»¶IDå†²çª
                        search_supplier = st.text_input(f"ğŸ” æœç´¢ä¾›åº”å•† ({dept_name})", key=f"search_s_{i}")
                    with c2:
                        search_equipment = st.text_input(f"ğŸ” æœç´¢è®¾å¤‡ç±»å‹ ({dept_name})", key=f"search_e_{i}")
                    
                    if search_supplier:
                        dept_df = dept_df[dept_df['ä¾›åº”å•†'].astype(str).str.contains(search_supplier, case=False)]
                    if search_equipment and 'è®¾å¤‡ç±»å‹' in dept_df.columns:
                        dept_df = dept_df[dept_df['è®¾å¤‡ç±»å‹'].astype(str).str.contains(search_equipment, case=False)]
                    
                    # å±•ç¤ºè¡¨æ ¼
                    display_df = dept_df.drop(columns=["_record_id"], errors='ignore')
                    st.dataframe(display_df, use_container_width=True, hide_index=True)

                    # åˆ é™¤åŠŸèƒ½
                    with st.expander(f"ğŸ—‘ï¸ ç®¡ç† {dept_name} æ•°æ®"):
                        if not dept_df.empty and "_record_id" in dept_df.columns:
                            record_options = dept_df.to_dict('records')
                            def format_func(option):
                                supplier = option.get('ä¾›åº”å•†', 'æœªå‘½å')
                                device = option.get('è®¾å¤‡ç±»å‹', 'æœªçŸ¥è®¾å¤‡')
                                price = option.get('å•ä»·', 0)
                                return f"{supplier} - {device} (ï¿¥{price})"
                            
                            selected_record = st.selectbox("é€‰æ‹©è¦åˆ é™¤çš„è®°å½•", options=record_options, format_func=format_func, key=f"del_sel_{i}")
                            
                            if st.button("ç¡®è®¤åˆ é™¤", key=f"del_btn_{i}"):
                                if connector.delete_record(selected_record["_record_id"]):
                                    st.success("åˆ é™¤æˆåŠŸï¼")
                                    time.sleep(1)
                                    st.rerun()
                        else:
                            st.info("å½“å‰åˆ†ç±»ä¸‹æš‚æ— æ•°æ®å¯ç®¡ç†")

        else:
            st.info("è¡¨æ ¼ä¸ºç©ºï¼Œæˆ–è¿æ¥é£ä¹¦å¤±è´¥ã€‚è¯·å…ˆå½•å…¥æ•°æ®ã€‚")

    # --- åŠŸèƒ½ 2: å½•å…¥æŠ¥ä»· ---
    elif menu == "â• å½•å…¥æŠ¥ä»·":
        st.title("â• å½•å…¥æ–°æŠ¥ä»·")
        
        # éƒ¨é—¨é€‰æ‹©å™¨ï¼ˆæ”¾åœ¨è¡¨å•å¤–ï¼Œæ˜ç¡®åˆ†ç±»ï¼‰
        st.subheader("1. é€‰æ‹©æ‰€å±éƒ¨é—¨")
        selected_dept = st.selectbox("è¯·é€‰æ‹©æ•°æ®å½’å±éƒ¨é—¨", DEPARTMENTS)
        
        st.subheader("2. å¡«å†™è¯¦ç»†ä¿¡æ¯")
        with st.form("feishu_entry"):
            # ç¬¬ä¸€è¡Œ
            c1, c2, c3 = st.columns(3)
            with c1:
                seq_num = st.text_input("åºå·")
                project_loc = st.text_input("é¡¹ç›®åœ°ç‚¹")
                device_type = st.text_input("è®¾å¤‡ç±»å‹")
            with c2:
                supplier = st.text_input("ä¾›åº”å•†")
                contact = st.text_input("è”ç³»äºº")
                supply_date = st.text_input("ä¾›è´§æ—¥æœŸ (é€‰å¡«)")
            with c3:
                device_count = st.number_input("è®¾å¤‡æ•°é‡", min_value=0, step=1)
                purchase_advice = st.text_input("é‡‡è´­å»ºè®®")
            
            st.markdown("---")
            # ç¬¬äºŒè¡Œï¼šä»·æ ¼ç›¸å…³
            c4, c5, c6, c7 = st.columns(4)
            with c4:
                unit_price = st.number_input("å•ä»· (ä¸­æ ‡)", min_value=0.0)
            with c5:
                contract_amt = st.number_input("ä¸­æ ‡åˆåŒé¢", min_value=0.0)
            with c6:
                inquiry_unit = st.number_input("è¯¢ä»·å•ä»·", min_value=0.0)
            with c7:
                inquiry_total = st.number_input("è¯¢ä»·æ€»ä»·", min_value=0.0)
            
            note = st.text_area("å¤‡æ³¨")
            submitted = st.form_submit_button("ğŸš€ æäº¤åˆ°é£ä¹¦")
            
            if submitted:
                # å¿…å¡«é¡¹æ£€æŸ¥
                if supplier and device_type:
                    payload = {
                        "æ‰€å±éƒ¨é—¨": selected_dept,  # å†™å…¥é€‰æ‹©çš„éƒ¨é—¨
                        "åºå·": seq_num,
                        "é¡¹ç›®åœ°ç‚¹": project_loc,
                        "è®¾å¤‡ç±»å‹": device_type,
                        "è®¾å¤‡æ•°é‡": device_count,
                        "å•ä»·": unit_price,
                        "ä¸­æ ‡åˆåŒé¢": contract_amt,
                        "ä¾›è´§æ—¥æœŸ": supply_date,
                        "é‡‡è´­å»ºè®®": purchase_advice,
                        "ä¾›åº”å•†": supplier,
                        "è¯¢ä»·å•ä»·": inquiry_unit,
                        "è¯¢ä»·æ€»ä»·": inquiry_total,
                        "è”ç³»äºº": contact,
                        "å¤‡æ³¨": note,
                        "å½•å…¥æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    }
                    if connector.add_record(payload):
                        st.success(f"å·²åŒæ­¥è‡³é£ä¹¦ [{selected_dept}]ï¼š{supplier} - {device_type}")
                else:
                    st.warning("è¯·è‡³å°‘å¡«å†™ 'ä¾›åº”å•†' å’Œ 'è®¾å¤‡ç±»å‹'")

    # --- åŠŸèƒ½ 3: ä»·æ ¼åˆ†æ ---
    elif menu == "ğŸ“ˆ ä»·æ ¼åˆ†æ":
        st.title("ğŸ“ˆ æ•°æ®åˆ†æ")
        data = connector.get_records()
        if data:
            df = pd.DataFrame(data)
            
            # å¢åŠ éƒ¨é—¨ç­›é€‰å™¨
            st.subheader("éƒ¨é—¨åˆ†æç­›é€‰")
            dept_filter = st.multiselect("é€‰æ‹©è¦åˆ†æçš„éƒ¨é—¨", DEPARTMENTS, default=DEPARTMENTS)
            
            if "æ‰€å±éƒ¨é—¨" in df.columns:
                df = df[df["æ‰€å±éƒ¨é—¨"].isin(dept_filter)]
            
            # å›¾è¡¨
            if not df.empty:
                if "å•ä»·" in df.columns and "è®¾å¤‡ç±»å‹" in df.columns:
                    st.subheader("è®¾å¤‡ç±»å‹ vs ä¸­æ ‡å•ä»·")
                    df['å•ä»·'] = pd.to_numeric(df['å•ä»·'], errors='coerce')
                    st.bar_chart(df, x="è®¾å¤‡ç±»å‹", y="å•ä»·")
                else:
                    st.info("æ•°æ®å­—æ®µä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨ã€‚")
            else:
                st.info("æ‰€é€‰éƒ¨é—¨æš‚æ— æ•°æ®ã€‚")

